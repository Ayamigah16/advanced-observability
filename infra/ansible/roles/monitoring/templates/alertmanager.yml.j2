global:
  resolve_timeout: 5m
  smtp_from: "{{ alertmanager_smtp_from }}"
  smtp_smarthost: "{{ alertmanager_smtp_smarthost }}"
  smtp_auth_username: "{{ alertmanager_smtp_username }}"
  smtp_auth_password: "{{ alertmanager_smtp_password }}"
  smtp_require_tls: true
  slack_api_url: "{{ alertmanager_slack_webhook_url }}"

# ---------------------------------------------------------------------------
# Routing tree
# Strategy:
#   - All alerts default to #alerts-warning Slack channel.
#   - critical severity also hits #alerts-critical and email oncall.
#   - Inhibit warnings when a critical fires for the same alertname+instance.
# ---------------------------------------------------------------------------
route:
  receiver: slack-warning
  group_by: ["alertname", "service", "severity"]
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  routes:
    - matchers:
        - severity = "critical"
      receiver: slack-critical
      continue: true  # also send to email-oncall below

    - matchers:
        - severity = "critical"
      receiver: email-oncall

receivers:
  - name: slack-warning
    slack_configs:
      - channel: "{{ alertmanager_slack_channel_warning }}"
        send_resolved: true
        title: |-
          [{{ "{{" }} .Status | toUpper {{ "}}" }}{{ "{{" }} if eq .Status "firing" {{ "}}" }}:{{ "{{" }} .Alerts.Firing | len {{ "}}" }}{{ "{{" }} end {{ "}}" }}] {{ "{{" }} .CommonLabels.alertname {{ "}}" }}
        text: |-
          {{ "{{" }} range .Alerts {{ "}}" }}
          *Alert:* {{ "{{" }} .Labels.alertname {{ "}}" }} ({{ "{{" }} .Labels.severity {{ "}}" }})
          *Summary:* {{ "{{" }} .Annotations.summary {{ "}}" }}
          *Description:* {{ "{{" }} .Annotations.description {{ "}}" }}
          *Instance:* {{ "{{" }} .Labels.instance {{ "}}" }}
          {{ "{{" }} end {{ "}}" }}

  - name: slack-critical
    slack_configs:
      - channel: "{{ alertmanager_slack_channel_critical }}"
        send_resolved: true
        title: |-
          [CRITICAL{{ "{{" }} if eq .Status "resolved" {{ "}}" }} RESOLVED{{ "{{" }} end {{ "}}" }}] {{ "{{" }} .CommonLabels.alertname {{ "}}" }}
        text: |-
          {{ "{{" }} range .Alerts {{ "}}" }}
          *Description:* {{ "{{" }} .Annotations.description {{ "}}" }}
          *Instance:* {{ "{{" }} .Labels.instance {{ "}}" }}
          {{ "{{" }} end {{ "}}" }}
        color: '{{ "{{" }} if eq .Status "firing" {{ "}}" }}danger{{ "{{" }} else {{ "}}" }}good{{ "{{" }} end {{ "}}" }}'

  - name: email-oncall
    email_configs:
      - to: "{{ alertmanager_email_oncall }}"
        send_resolved: true
        headers:
          Subject: |-
            [{{ "{{" }} .Status | toUpper {{ "}}" }}] {{ "{{" }} .CommonLabels.alertname {{ "}}" }}
        html: |-
          <h3>{{ "{{" }} .CommonLabels.alertname {{ "}}" }}</h3>
          {{ "{{" }} range .Alerts {{ "}}" }}
          <p><b>Severity:</b> {{ "{{" }} .Labels.severity {{ "}}" }}<br>
          <b>Summary:</b> {{ "{{" }} .Annotations.summary {{ "}}" }}<br>
          <b>Description:</b> {{ "{{" }} .Annotations.description {{ "}}" }}</p>
          {{ "{{" }} end {{ "}}" }}

# ---------------------------------------------------------------------------
# Inhibit rules â€” suppress warning when a critical exists for the same target
# ---------------------------------------------------------------------------
inhibit_rules:
  - source_matchers:
      - severity = "critical"
    target_matchers:
      - severity = "warning"
    equal:
      - alertname
      - instance
