---
# =============================================================================
# Monitoring Role: Prometheus + Alertmanager + Grafana
# Runs on: [monitoring] inventory group (dedicated EC2 instance)
# =============================================================================

# ---------------------------------------------------------------------------
# System users and directories
# ---------------------------------------------------------------------------

- name: Create prometheus system group
  ansible.builtin.group:
    name: "{{ prometheus_group }}"
    system: true
    state: present

- name: Create prometheus system user
  ansible.builtin.user:
    name: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    system: true
    shell: /sbin/nologin
    create_home: false

- name: Create alertmanager system group
  ansible.builtin.group:
    name: "{{ alertmanager_group }}"
    system: true
    state: present

- name: Create alertmanager system user
  ansible.builtin.user:
    name: "{{ alertmanager_user }}"
    group: "{{ alertmanager_group }}"
    system: true
    shell: /sbin/nologin
    create_home: false

- name: Create Prometheus directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: "0755"
  loop:
    - "{{ prometheus_config_dir }}"
    - "{{ prometheus_data_dir }}"

- name: Create Alertmanager directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ alertmanager_user }}"
    group: "{{ alertmanager_group }}"
    mode: "0755"
  loop:
    - "{{ alertmanager_config_dir }}"
    - "{{ alertmanager_data_dir }}"

# ---------------------------------------------------------------------------
# Prometheus binary
# ---------------------------------------------------------------------------

- name: Download Prometheus archive
  ansible.builtin.get_url:
    url: "https://github.com/prometheus/prometheus/releases/download/v{{ prometheus_version }}/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
    dest: "/tmp/prometheus-{{ prometheus_version }}.tar.gz"
    mode: "0644"
  register: prometheus_download

- name: Extract Prometheus
  ansible.builtin.unarchive:
    src: "/tmp/prometheus-{{ prometheus_version }}.tar.gz"
    dest: /tmp
    remote_src: true
  when: prometheus_download.changed  # noqa: no-handler

- name: Install Prometheus binaries
  ansible.builtin.copy:
    src: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64/{{ item }}"
    dest: "{{ prometheus_install_dir }}/{{ item }}"
    owner: root
    group: root
    mode: "0755"
    remote_src: true
  loop:
    - prometheus
    - promtool
  notify: Restart prometheus

- name: Deploy Prometheus alert rules
  ansible.builtin.template:
    src: prometheus-alert-rules.yml.j2
    dest: "{{ prometheus_config_dir }}/alert_rules.yml"
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: "0640"
    validate: "{{ prometheus_install_dir }}/promtool check rules %s"
  notify: Restart prometheus

- name: Deploy Prometheus configuration
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ prometheus_config_dir }}/prometheus.yml"
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: "0640"
    validate: "{{ prometheus_install_dir }}/promtool check config %s"
  notify: Restart prometheus

- name: Install Prometheus systemd unit
  ansible.builtin.template:
    src: prometheus.service.j2
    dest: /etc/systemd/system/prometheus.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart prometheus

# ---------------------------------------------------------------------------
# Alertmanager binary
# ---------------------------------------------------------------------------

- name: Download Alertmanager archive
  ansible.builtin.get_url:
    url: "https://github.com/prometheus/alertmanager/releases/download/v{{ alertmanager_version }}/alertmanager-{{ alertmanager_version }}.linux-amd64.tar.gz"
    dest: "/tmp/alertmanager-{{ alertmanager_version }}.tar.gz"
    mode: "0644"
  register: alertmanager_download

- name: Extract Alertmanager
  ansible.builtin.unarchive:
    src: "/tmp/alertmanager-{{ alertmanager_version }}.tar.gz"
    dest: /tmp
    remote_src: true
  when: alertmanager_download.changed  # noqa: no-handler

- name: Install Alertmanager binaries
  ansible.builtin.copy:
    src: "/tmp/alertmanager-{{ alertmanager_version }}.linux-amd64/{{ item }}"
    dest: "{{ alertmanager_install_dir }}/{{ item }}"
    owner: root
    group: root
    mode: "0755"
    remote_src: true
  loop:
    - alertmanager
    - amtool
  notify: Restart alertmanager

- name: Deploy Alertmanager configuration
  ansible.builtin.template:
    src: alertmanager.yml.j2
    dest: "{{ alertmanager_config_dir }}/alertmanager.yml"
    owner: "{{ alertmanager_user }}"
    group: "{{ alertmanager_group }}"
    mode: "0640"
    validate: "{{ alertmanager_install_dir }}/amtool check-config %s"
  notify: Restart alertmanager
  no_log: true  # contains webhook/smtp credentials

- name: Install Alertmanager systemd unit
  ansible.builtin.template:
    src: alertmanager.service.j2
    dest: /etc/systemd/system/alertmanager.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart alertmanager

# ---------------------------------------------------------------------------
# Grafana
# ---------------------------------------------------------------------------

- name: Add Grafana YUM repository
  ansible.builtin.yum_repository:
    name: grafana
    description: Grafana OSS
    baseurl: https://rpm.grafana.com
    repo_gpgcheck: true
    gpgcheck: true
    gpgkey: https://rpm.grafana.com/gpg.key
    sslverify: true
    enabled: true

- name: Install Grafana
  ansible.builtin.yum:
    name: grafana
    state: present

- name: Configure Grafana admin credentials
  ansible.builtin.lineinfile:
    path: /etc/grafana/grafana.ini
    regexp: "^;?{{ item.key }}"
    line: "{{ item.key }} = {{ item.value }}"
    insertafter: "^\\[security\\]"
  loop:
    - { key: "admin_user", value: "{{ grafana_admin_user }}" }
    - { key: "admin_password", value: "{{ grafana_admin_password }}" }
  no_log: true
  notify: Restart grafana

- name: Create Grafana provisioning directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: grafana
    mode: "0755"
  loop:
    - /etc/grafana/provisioning/datasources
    - /etc/grafana/provisioning/dashboards

- name: Provision Prometheus datasource
  ansible.builtin.template:
    src: grafana-datasource.yml.j2
    dest: /etc/grafana/provisioning/datasources/prometheus.yml
    owner: root
    group: grafana
    mode: "0640"
  notify: Restart grafana

- name: Provision dashboard provider config
  ansible.builtin.template:
    src: grafana-dashboard-provider.yml.j2
    dest: /etc/grafana/provisioning/dashboards/default.yml
    owner: root
    group: grafana
    mode: "0640"
  notify: Restart grafana

- name: Copy DevSecOps observability dashboard
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../../infra/observability/grafana/dashboards/devsecops-observability-dashboard.json"
    dest: /etc/grafana/provisioning/dashboards/devsecops-observability-dashboard.json
    owner: root
    group: grafana
    mode: "0640"
  notify: Restart grafana

- name: Enable and start Prometheus
  ansible.builtin.service:
    name: prometheus
    state: started
    enabled: true

- name: Enable and start Alertmanager
  ansible.builtin.service:
    name: alertmanager
    state: started
    enabled: true

- name: Enable and start Grafana
  ansible.builtin.service:
    name: grafana-server
    state: started
    enabled: true
